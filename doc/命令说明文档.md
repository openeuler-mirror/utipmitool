# utipmitool 命令说明文档

## 项目概述

`utipmitool` 是一个用 Rust 重新实现的 IPMI 工具，兼容原版 ipmitool 的命令行接口。该工具提供了对 IPMI（智能平台管理接口）设备的管理和监控功能。

## 程序入口

- **主程序**: `utipmitool`
- **配置文件**: `Cargo.toml`
- **主要依赖**: clap (命令行解析), tokio (异步运行时), tracing (日志)

## 全局参数

### 基本信息参数
- `-h, --help`: 显示帮助信息
- `-V, --version`: 显示版本信息
- `-v`: 详细输出模式（可重复使用增加详细级别）
- `-c, --csv-output`: CSV 格式输出

### 设备接口参数
- `-I, --interface <TYPE>`: 接口类型（默认: open）
  - `open`: 本地 OpenIPMI 接口
- `-d <NUM>`: 设备编号（默认: 0）
- `-D, --devfile <PATH>`: 设备文件路径

### 网络参数
- `-H, --hostname <HOST>`: 远程主机名或IP地址
- `-p, --port <PORT>`: 端口号（默认: 623）
- `-4`: 强制使用 IPv4
- `-6`: 强制使用 IPv6

### 安全认证参数
- `-U, --username <USER>`: 用户名
- `-P, --password <PASS>`: 密码
- `-f, --password-file <FILE>`: 密码文件
- `-a, --password-prompt`: 提示输入密码
- `-L, --privilege <LEVEL>`: 权限级别（默认: administrator）
  - `callback`, `user`, `operator`, `administrator`, `oem`
- `-A, --authtype <TYPE>`: 认证类型
  - `none`, `md2`, `md5`, `oem`, `password`

### 高级功能参数
- `-S, --sdr-cache <FILE>`: SDR 缓存文件
- `-O, --sel-oem <FILE>`: SEL OEM 文件
- `-N, --timeout <SEC>`: 超时时间（默认: 2秒）
- `-R, --retries <NUM>`: 重试次数（默认: 4次）

### 桥接参数
- `-b, --target-channel <NUM>`: 目标通道（默认: 0）
- `-t, --target-addr <ADDR>`: 目标地址（默认: 0）
- `-T, --transit-addr <ADDR>`: 传输地址（默认: 0）
- `-B, --transit-channel <NUM>`: 传输通道（默认: 0）
- `-l, --target-lun <LUN>`: 目标 LUN（默认: 0）
- `-m, --arg-addr <ADDR>`: 参数地址（默认: 0）

### 密钥管理
- `-k, --kg-key <KEY>`: KG 密钥
- `-K, --kg-env`: 从环境变量获取 KG 密钥
- `-y, --hex-key <KEY>`: 十六进制密钥
- `-Y, --key-prompt`: 提示输入密钥

### LANPlus 专用参数
- `-C, --cipher-suite <NUM>`: 密码套件编号

### SOL 参数
- `-e, --sol-escape <CHAR>`: SOL 转义字符

## 主命令和子命令

### 1. chassis - 机箱控制

机箱电源和状态管理命令。

#### 子命令

##### `status`
显示机箱状态信息
```bash
utipmitool chassis status
```

##### `power <action>`
电源控制操作
- `status`: 显示电源状态
- `on` / `up`: 开机
- `off` / `down`: 关机
- `cycle`: 电源循环
- `reset`: 硬重启
- `diag`: 诊断中断
- `soft` / `acpi`: 软关机（ACPI）

```bash
utipmitool chassis power status
utipmitool chassis power on
utipmitool chassis power off
utipmitool chassis power cycle
utipmitool chassis power reset
```

##### `identify [seconds]`
机箱识别灯控制
- `seconds`: 识别时间（0-255秒，可选）

```bash
utipmitool chassis identify        # 默认15秒
utipmitool chassis identify 30     # 30秒
utipmitool chassis identify 0      # 关闭
```

##### `restart-cause`
显示系统重启原因

```bash
utipmitool chassis restart-cause
```

##### `bootdev <device> [--clear-cmos]`
设置启动设备
- `device`: 启动设备类型
  - `none`: 无特定设备
  - `pxe`: PXE 网络启动
  - `disk`: 硬盘启动
  - `safe`: 安全模式
  - `diag`: 诊断模式
  - `cdrom`: 光盘启动
  - `bios`: BIOS 设置
  - `floppy`: 软盘启动
- `--clear-cmos`: 清除 CMOS（可选）

```bash
utipmitool chassis bootdev pxe
utipmitool chassis bootdev disk --clear-cmos
```

### 2. mc - 管理控制器

BMC（基板管理控制器）相关命令。

#### 子命令

##### `info`
显示设备ID和能力信息
```bash
utipmitool mc info
```
输出包括：
- 设备ID
- 设备版本
- 固件版本
- IPMI版本
- 制造商ID和名称
- 产品ID
- 设备可用性
- 支持的功能

##### `reset [type]`
重置管理控制器
- `type`: 重置类型（默认: warm）
  - `warm`: 热重启
  - `cold`: 冷重启

```bash
utipmitool mc reset
utipmitool mc reset warm
utipmitool mc reset cold
```

### 3. sensor - 传感器管理

传感器数据读取和管理。

#### 子命令

##### `list`
列出所有传感器和阈值信息
```bash
utipmitool sensor list
```

### 4. sdr - SDR 仓库管理

传感器数据记录（Sensor Data Record）管理。

#### 子命令

##### `info`
显示 SDR 仓库信息
```bash
utipmitool sdr info
```

##### `list [record-type]`
列出 SDR 条目（标准格式）
- `record-type`: 记录类型过滤器（可选）
  - `all`: 所有记录
  - `full`: 完整传感器记录
  - `compact`: 紧凑传感器记录
  - `event`: 仅事件传感器记录
  - `mcloc`: 管理控制器定位记录
  - `fru`: FRU 定位记录
  - `generic`: 通用设备定位记录

```bash
utipmitool sdr list
utipmitool sdr list full
utipmitool sdr list compact
```

##### `elist [record-type]`
列出 SDR 条目（扩展格式，包含传感器编号和实体信息）
- `record-type`: 同 `list` 命令

```bash
utipmitool sdr elist
utipmitool sdr elist full
```

### 5. sel - 系统事件日志

系统事件日志（System Event Log）管理。

#### 子命令

##### `info`
显示 SEL 信息
```bash
utipmitool sel info
```

##### `list [order] [count]`
列出 SEL 条目
- `order`: 显示顺序（可选）
  - `first`: 从最早开始
  - `last`: 从最新开始
- `count`: 显示条目数量（可选）

```bash
utipmitool sel list
utipmitool sel list first 10
utipmitool sel list last 5
```

##### `elist [order] [count]`
列出 SEL 条目（扩展格式）
- 参数同 `list` 命令

```bash
utipmitool sel elist
utipmitool sel elist first 10
```

### 6. user - 用户管理

IPMI 用户账户管理。

#### 子命令

##### `summary`
显示用户摘要信息
```bash
utipmitool user summary
```

##### `list`
列出所有用户信息
```bash
utipmitool user list
```

##### `set name <user-id> <username>`
设置用户名
```bash
utipmitool user set name 2 admin
```

##### `set password <user-id> [password]`
设置或清除用户密码
```bash
utipmitool user set password 2 mypassword
utipmitool user set password 2              # 清除密码
```

##### `disable <user-id>`
禁用指定用户
```bash
utipmitool user disable 3
```

##### `enable <user-id>`
启用指定用户
```bash
utipmitool user enable 3
```

##### `priv <user-id> <privilege> [channel]`
设置用户权限级别
- `privilege`: 权限级别（1-5, 15）
  - `1` (0x1): Callback
  - `2` (0x2): User
  - `3` (0x3): Operator
  - `4` (0x4): Administrator
  - `5` (0x5): OEM Proprietary
  - `15` (0xF): No Access
- `channel`: 通道号（可选）

```bash
utipmitool user priv 2 4        # 设置用户2为管理员
utipmitool user priv 3 0x4      # 十六进制格式
utipmitool user priv 5 2 1      # 在通道1设置用户5为用户级别
```

##### `test <user-id> <format> [password]`
测试密码存储格式
- `format`: 密码格式
  - `16`: 16字节密码格式
  - `20`: 20字节密码格式
- `password`: 测试密码（可选）

```bash
utipmitool user test 2 16
utipmitool user test 3 20 mypass
```

### 7. lan - LAN 配置

网络配置管理。

#### 子命令

##### `print [--channel <num>]`
显示指定通道的 LAN 配置
- `--channel`: 通道号（默认: 1）

```bash
utipmitool lan print
utipmitool lan print --channel 2
```

##### `set --channel <num> <param> <value>`
设置 LAN 配置参数
- `--channel`: 通道号（默认: 1）
- `param`: 参数名称
- `value`: 参数值

```bash
utipmitool lan set --channel 1 ipaddr 192.168.1.100
utipmitool lan set --channel 1 netmask 255.255.255.0
```

### 8. sol - 串行重定向

串行重定向（Serial Over LAN）管理。

#### 子命令

##### `info`
显示 SOL 信息
```bash
utipmitool sol info
```

##### `activate [--instance <num>]`
激活 SOL 会话
- `--instance`: 实例编号（可选）

```bash
utipmitool sol activate
utipmitool sol activate --instance 1
```

##### `deactivate [--instance <num>]`
停用 SOL 会话
- `--instance`: 实例编号（可选）

```bash
utipmitool sol deactivate
utipmitool sol deactivate --instance 1
```

##### `set <param> <value>`
设置 SOL 参数
- `param`: 参数类型
  - `enabled`: 启用状态
  - `privilege-level`: 权限级别
  - `baud-rate`: 波特率
- `value`: 参数值

```bash
utipmitool sol set enabled true
utipmitool sol set baud-rate 115200
```

## 使用示例

### 基本设备信息查询
```bash
# 查看设备信息
utipmitool mc info

# 查看机箱状态
utipmitool chassis status

# 查看传感器列表
utipmitool sensor list
```

### 电源管理
```bash
# 查看电源状态
utipmitool chassis power status

# 开机
utipmitool chassis power on

# 关机
utipmitool chassis power off

# 重启
utipmitool chassis power reset
```

### 远程管理
```bash
# 通过网络连接远程BMC
utipmitool -I lan -H 192.168.1.100 -U admin -P password mc info

# 使用详细输出
utipmitool -v -I lan -H 192.168.1.100 -U admin -P password chassis status
```

### 用户管理
```bash
# 查看用户列表
utipmitool user list

# 创建新用户
utipmitool user set name 3 newuser
utipmitool user set password 3 newpassword
utipmitool user priv 3 4
utipmitool user enable 3
```

### 日志和事件
```bash
# 查看系统事件日志
utipmitool sel list

# 查看SDR信息
utipmitool sdr info
utipmitool sdr list
```

## 实现状态总结

### 已完全实现的命令
1. **chassis**: 机箱控制（7个子命令）
2. **mc**: 管理控制器（2个子命令）
3. **sensor**: 传感器管理（1个子命令）
4. **sdr**: SDR管理（3个子命令）
5. **sel**: 事件日志（3个子命令）
6. **user**: 用户管理（8个子命令）
7. **lan**: 网络配置（2个子命令）
8. **sol**: 串行重定向（4个子命令）

### 总计
- **主命令**: 8个
- **子命令**: 30个
- **全局参数**: 30+个

### 接口支持
- **已实现**: `open` (本地OpenIPMI接口)
- **计划实现**: `lan`, `lanplus`, `serial` 等

该项目已经实现了 IPMI 工具的核心功能，涵盖了设备管理、电源控制、传感器监控、用户管理、网络配置等主要应用场景。 